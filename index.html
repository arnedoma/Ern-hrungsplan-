<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individueller Ern√§hrungsplan - Pflegeheim "Haus Sonnenschein"</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #f8fbff 0%, #e3f2fd 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border-left: 5px solid #74b9ff;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #2980b9;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #74b9ff;
            padding-bottom: 10px;
        }

        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .info-box {
            background: linear-gradient(135deg, #e8f5e8 0%, #b8e6b8 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #27ae60;
        }

        .info-box h3 {
            color: #27ae60;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: white;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .calculation-box {
            background: linear-gradient(135deg, #e8f8f5 0%, #a8e6cf 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #1abc9c;
        }

        .calculation-box h4 {
            color: #16a085;
            margin-bottom: 10px;
        }

        .formula {
            font-family: 'Courier New', monospace;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 3px solid #74b9ff;
        }

        .result {
            background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            color: #2d3436;
            border-left: 5px solid #636e72;
        }

        .meal-plan {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmin(350px, 1fr)); /* Adjusted minmax to minmin for a smaller initial size */
            gap: 20px;
        }

        .meal-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #2196f3;
        }

        .meal-card h4 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .normal-texture, .modified-texture {
            margin-bottom: 15px;
        }

        .normal-texture h5 {
            color: #27ae60;
            margin-bottom: 8px;
        }

        .modified-texture h5 {
            color: #7f8c8d;
            margin-bottom: 8px;
        }

        .texture-note {
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 5px;
            font-style: italic;
            margin-top: 10px;
        }

        .recommendations {
            background: linear-gradient(135deg, #f0f8ff 0%, #e1f5fe 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #29b6f6;
        }

        .alert {
            background: linear-gradient(135deg, #607d8b 0%, #546e7a 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #34495e;
            color: white;
            border-radius: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .highlight {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            border-left: 5px solid #4caf50;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: flex-start; /* Align buttons to the left */
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }

        .btn-calculate, .btn-save, .btn-clear, .btn-data-save {
            background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            white-space: nowrap; /* Prevent text wrapping inside buttons */
        }

        .btn-save {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); /* Blue for save */
        }

        .btn-clear {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); /* Red for clear */
        }

        .btn-data-save {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); /* Orange for data save */
        }

        .btn-calculate:hover, .btn-save:hover, .btn-clear:hover, .btn-data-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        #dataLoadInstruction {
            background: linear-gradient(135deg, #ffeaa7 0%, #fed330 100%);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 5px solid #fdcb6e;
            color: #2d3436;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            .btn-group {
                flex-direction: column; /* Stack buttons vertically on small screens */
                align-items: stretch; /* Make buttons full width */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Individueller Ern√§hrungsplan Haus Sonnenschein</h1>
            <p>Ern√§hrungstherapie f√ºr Bewohner mit einem erh√∂htem Energiebedarf und zur Gewichtszunahme</p>
        </div>

        <div class="card">
            <h2>üë§ Bewohnerinformationen eingeben</h2>
            <div class="patient-info">
                <div class="info-box">
                    <h3>Pers√∂nliche Daten</h3>
                    <div class="input-group">
                        <label for="patientName">Name des Bewohners:</label>
                        <input type="text" id="patientName" placeholder="z.B. Max Mustermann">
                    </div>
                    <div class="two-column">
                        <div class="input-group">
                            <label for="patientAge">Alter (Jahre):</label>
                            <input type="number" id="patientAge" placeholder="z.B. 72" min="18" max="120">
                        </div>
                        <div class="input-group">
                            <label for="patientGender">Geschlecht:</label>
                            <select id="patientGender">
                                <option value="">Bitte w√§hlen</option>
                                <option value="m√§nnlich">m√§nnlich</option>
                                <option value="weiblich">weiblich</option>
                                <option value="divers">divers</option>
                            </select>
                        </div>
                    </div>
                    <div class="two-column">
                        <div class="input-group">
                            <label for="currentWeight">Aktuelles Gewicht (kg):</label>
                            <input type="number" id="currentWeight" placeholder="z.B. 58" step="0.1" min="30" max="200">
                        </div>
                        <div class="input-group">
                            <label for="height">K√∂rpergr√∂√üe (cm):</label>
                            <input type="number" id="height" placeholder="z.B. 175" min="120" max="220">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="targetWeight">Zielgewicht (kg):</label>
                        <input type="number" id="targetWeight" placeholder="z.B. 68" step="0.1" min="30" max="200">
                    </div>
                    <div class="result" id="bmiResult" style="display: none;">
                        <p id="bmiValue"></p>
                        <p id="weightGainNeeded"></p>
                    </div>
                </div>
                <div class="info-box">
                    <h3>Gesundheitliche Situation</h3>
                    <div class="input-group">
                        <label for="diagnosis">Hauptdiagnose:</label>
                        <input type="text" id="diagnosis" placeholder="z.B. Malnutrition, Dysphagie">
                    </div>
                    <div class="input-group">
                        <label for="swallowing">Schluckbeschwerden:</label>
                        <select id="swallowing">
                            <option value="">Bitte w√§hlen</option>
                            <option value="keine">Keine Schluckbeschwerden</option>
                            <option value="leicht">Leichte Schluckbeschwerden</option>
                            <option value="m√§√üig">M√§√üige Schluckbeschwerden</option>
                            <option value="schwer">Schwere Schluckbeschwerden</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="activity">Aktivit√§tslevel:</label>
                        <select id="activity">
                            <option value="1.2">Bettl√§gerig (PAL 1.2)</option>
                            <option value="1.3">Sitzend, wenig Aktivit√§t (PAL 1.3)</option>
                            <option value="1.4">Leichte Aktivit√§t (PAL 1.4)</option>
                            <option value="1.5">M√§√üige Aktivit√§t (PAL 1.5)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="specialNotes">Besondere Hinweise:</label>
                        <textarea id="specialNotes" rows="3" placeholder="z.B. Allergien, Unvertr√§glichkeiten, weitere Erkrankungen"></textarea>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-calculate" onclick="calculateValues()">üìä BMI und Energiebedarf berechnen</button>
                <button class="btn-data-save" onclick="saveData()">üíæ Daten speichern</button>
                <button class="btn-save" onclick="saveAsText()">üìÑ Protokoll als Text speichern</button>
                <button class="btn-clear" onclick="clearForm()">üîÑ Protokoll leeren</button>
            </div>
             <div id="dataLoadInstruction" style="display:none;">
                <p>‚ö†Ô∏è **Daten laden:** Aus Sicherheitsgr√ºnden k√∂nnen Browser lokale Dateien nicht automatisch einlesen.</p>
                <p>Ziehe die `daten_*.json`-Datei des Bewohners hierher oder klicke, um sie auszuw√§hlen.</p>
                <input type="file" id="fileInput" accept=".json" style="margin-top: 10px;">
            </div>
        </div>

        <div class="card">
            <h2>üçΩÔ∏è Vorlieben & Abneigungen</h2>
            <div class="patient-info">
                <div class="info-box">
                    <h3>‚úÖ Vorlieben</h3>
                    <div class="input-group">
                        <label for="preferences">Bevorzugte Speisen und Getr√§nke:</label>
                        <textarea id="preferences" rows="5" placeholder="z.B. Warme Suppen, Milchprodukte, weiche Speisen, bestimmte Geschmacksrichtungen"></textarea>
                    </div>
                </div>
                <div class="info-box">
                    <h3>‚ùå Abneigungen/Intoleranzen</h3>
                    <div class="input-group">
                        <label for="dislikes">Abgelehnte Speisen, Allergien, Intoleranzen:</label>
                        <textarea id="dislikes" rows="5" placeholder="z.B. Rohkost, N√ºsse, Laktoseintoleranz, scharfe Gew√ºrze"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìä Energiebedarfsberechnung</h2>

            <div class="calculation-box">
                <h4>1. Grundumsatz (Mifflin-St Jeor Formel)</h4>
                <div class="formula">
                    <strong>F√ºr M√§nner:</strong> BMR = (10 √ó Gewicht in kg) + (6.25 √ó Gr√∂√üe in cm) - (5 √ó Alter) + 5
                </div>
                <div class="formula">
                    <strong>F√ºr Frauen:</strong> BMR = (10 √ó Gewicht in kg) + (6.25 √ó Gr√∂√üe in cm) - (5 √ó Alter) - 161
                </div>
                <div class="result" id="bmrResult" style="display: none;">
                    <p id="bmrValue"></p>
                </div>
            </div>

            <div class="calculation-box">
                <h4>2. Leistungsumsatz (PAL-Faktor)</h4>
                <p><strong>Aktivit√§tslevel wird automatisch aus der Auswahl √ºbernommen</strong></p>
                <div class="formula">
                    Gesamtumsatz = BMR √ó PAL-Faktor
                </div>
                <div class="result" id="totalEnergyResult" style="display: none;">
                    <p id="totalEnergyValue"></p>
                </div>
            </div>

            <div class="calculation-box">
                <h4>3. Zus√§tzlicher Energiebedarf f√ºr Gewichtszunahme</h4>
                <p><strong>Empfohlene Gewichtszunahme:</strong> 0,150 - 0,300kg pro Woche</p>
                <div class="input-group">
                    <label for="weeklyGoal">Gew√ºnschte w√∂chentliche Zunahme (kg):</label>
                    <select id="weeklyGoal">
                        <option value="0.25">0.25kg/Woche (+ 250 kcal/Tag)</option>
                        <option value="0.75">0.75 kg/Woche (+750 kcal/Tag)</option>
                        <option value="1.0">1.0 kg/Woche (+1000 kcal/Tag)</option>
                    </select>
                </div>
            </div>

            <div class="highlight" id="finalResult" style="display: none;">
                <h3>üéØ Gesamtenergiebedarf f√ºr Gewichtszunahme</h3>
                <p id="maintenanceCalories"></p>
                <p id="buildupCalories"></p>
                <p id="totalCalories"></p>
                <p id="proteinNeeds"></p>
            </div>
        </div>

        <div class="card">
            <h2>‚è∞ Tagesablauf der Mahlzeitenversorgung</h2>
            <div class="meal-plan">
                <div class="meal-card">
                    <h4>üåÖ Fr√ºhst√ºck (07:00 Uhr) - ca. 550 kcal</h4>
                    <div class="input-group">
                        <label for="breakfastNormal">Normale Konsistenz:</label>
                        <textarea id="breakfastNormal" rows="3" placeholder="z.B. Haferbrei mit Vollmilch, Banane, Honig, Vollmilch"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="breakfastModified">Bei Schluckbeschwerden:</label>
                        <textarea id="breakfastModified" rows="3" placeholder="z.B. Haferbrei p√ºriert, Banane p√ºriert, Honig, Andickmittel"></textarea>
                    </div>
                </div>

                <div class="meal-card">
                    <h4>ü•® Zwischenmahlzeit (10:00 Uhr) - ca. 320 kcal</h4>
                    <div class="input-group">
                        <label for="snackNormal">Normale Konsistenz:</label>
                        <textarea id="snackNormal" rows="3" placeholder="z.B. Vollmilchjoghurt, Kompott, Keks (eingeweicht)"></textarea>
                   </div>
                    <div class="input-group">
                        <label for="snackModified">Bei Schluckbeschwerden:</label>
                        <textarea id="snackModified" rows="3" placeholder="z.B. Joghurt glatt, Kompott passiert, Keks aufgel√∂st/p√ºriert"></textarea>
                    </div>
                </div>

                <div class="meal-card">
                    <h4>üçΩÔ∏è Mittagessen (12:30 Uhr) - ca. 540 kcal</h4>
                    <p>Siehe ausgeh√§ngter Speiseplan.</p>
                    <p class="texture-note">Anpassung der Konsistenz bei Schluckbeschwerden gem√§√ü Speiseplan und individuellen Bed√ºrfnissen (p√ºriert, passiert, angedickt).</p>
                </div>

                <div class="meal-card">
                    <h4>‚òï Nachmittagssnack (15:30 Uhr) - ca. 380 kcal</h4>
                    <div class="normal-texture">
                        <h5>Normale Konsistenz:</h5>
                        <ul>
                            <li>Milchkaffee (200ml)</li>
                            <li>Grie√üpudding (150g)</li>
                            <li>Fruchtsauce (50g)</li>
                        </ul>
                    </div>
                    <div class="modified-texture">
                        <h5>Bei Schluckbeschwerden:</h5>
                        <ul>
                            <li>Kaffee mit Andickmittel</li>
                            <li>Pudding glatt ger√ºhrt</li>
                            <li>Fruchtsauce passiert</li>
                        </ul>
                    </div>
                </div>

                <div class="meal-card">
                    <h4>üåô Abendessen (18:00 Uhr) - ca. 480 kcal</h4>
                    <div class="normal-texture">
                        <h5>Normale Konsistenz:</h5>
                        <ul>
                            <li>Kr√§ftige Fleischbr√ºhe (200ml)</li>
                            <li>Wei√übrot, entrindet (2 Scheiben)</li>
                            <li>Streichk√§se (30g)</li>
                            <li>Warme Milch (200ml)</li>
                        </ul>
                    </div>
                    <div class="modified-texture">
                        <h5>Bei Schluckbeschwerden:</h5>
                        <ul>
                            <li>Br√ºhe angedickt</li>
                            <li>Brot in Milch eingeweicht</li>
                            <li>K√§se geschmolzen/p√ºriert</li>
                            <li>Milch ggf. angedickt</li>
                        </ul>
                    </div>
                </div>

                <div class="meal-card">
                    <h4>üåÉ Sp√§tmahlzeit (20:30 Uhr) - ca. 290 kcal</h4>
                    <div class="normal-texture">
                        <h5>Normale Konsistenz:</h5>
                        <ul>
                            <li>Trinknahrung (200ml)</li>
                            <li>Oder: Milchshake mit Banane</li>
                        </ul>
                    </div>
                    <div class="modified-texture">
                        <h5>Bei Schluckbeschwerden:</h5>
                        <ul>
                            <li>Trinknahrung angedickt</li>
                            <li>L√∂ffelweise verabreichen</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üíä Zus√§tzliche Ma√ünahmen & Empfehlungen</h2>
            <div class="recommendations">
                <h4>üî¨ Supplementierung</h4>
                <div class="input-group">
                    <label for="supplementType">Hochkalorische Zusatzversorgung (Auswahl):</label>
                    <select id="supplementType" multiple size="7">
                        <option value="Hochkalorischer Shake">Hochkalorischer Shake</option>
                        <option value="Quarkspeisen">Quarkspeisen</option>
                        <option value="Pudding">Pudding</option>
                        <option value="Bananen">Bananen</option>
                        <option value="Sahnejoghurt">Sahnejoghurt</option>
                        <option value="Angereichertes Apfelmus">Angereichertes Apfelmus</option>
                        <option value="Nutella Brot">Nutella Brot</option>
                    </select>
                    <p class="texture-note" style="margin-top: 10px;">Bitte die gew√ºnschten Optionen ausw√§hlen (Strg/Cmd + Klick f√ºr Mehrfachauswahl).</p>
                </div>
                <ul>
                    <li><strong>Hochkalorische und vollbilanzierte Trinknahrung im Haus selber hergestellt:</strong> 1-2x t√§glich zwischen den Mahlzeiten</li>
                </ul>

                <h4>üçØ Konsistenzanpassungen bei Schluckbeschwerden</h4>
                <ul>
                    <li><strong>Fl√ºssigkeiten:</strong> IDDSI Level 1-3 je nach Bedarf</li>
                    <li><strong>Andickmittel:</strong> ModuleN oder ThickenUp bei Bedarf</li>
                    <li><strong>Texturen:</strong> P√ºrierte bis weiche Kost (IDDSI 4-6)</li>
                    <li><strong>Temperatur:</strong> Warme Speisen bevorzugt, keine extremen Temperaturen</li>
                </ul>

                <h4>‚ö° Energieanreicherung</h4>
                <ul>
                    <li>Aufbaupulver in Getr√§nke einr√ºhren</li>
                    <li>Lein√∂l (5-10ml) zu Speisen</li>
                    <li>Sahne und Butter gro√üz√ºgig verwenden</li>
                    <li>Eiwei√üpulver in Milchprodukte und Herstellung individueller Eiwei√üreicher Kost</li>
                </ul>
            </div>
        </div>

        <div class="alert">
            <h3>‚ö†Ô∏è Wichtige Hinweise</h3>
            <p><strong>√úberwachung:</strong> W√∂chentliche Gewichtskontrolle, Fl√ºssigkeitsbilanz beachten</p>
            <p><strong>Schlucktest:</strong> Bei anhaltenden Problemen logop√§dische Evaluation</p>
            <p><strong>Anpassung:</strong> Plan alle 2 Wochen entsprechend Fortschritt √ºberpr√ºfen</p>
        </div>

        <div class="card">
            <h2>üìà Monitoring & Erfolgskontrolle</h2>
            <table>
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Sollwert</th>
                        <th>Kontrollintervall</th>
                        <th>Ma√ünahmen bei Abweichung</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Gewichtszunahme</td>
                        <td>0.150 - 0,350 kg/Woche</td>
                        <td>2x w√∂chentlich</td>
                        <td>Kalorienerh√∂hung/Trinknahrung</td>
                    </tr>
                    <tr>
                        <td>Fl√ºssigkeitsaufnahme</td>
                        <td>1000-2000ml ggf nach √§rztlicher Anordnung/Tag</td>
                        <td>T√§glich</td>
                        <td>Andicken, Geschmack variieren</td>
                    </tr>
                    <tr>
                        <td>Proteinerh√∂hung</td>
                        <td>Individuell (ca. 1.2-1.5 g/kg KG)</td>
                        <td>W√∂chentlich</td>
                        <td>Eiwei√üreiche Kost/Supplemente</td>
                    </tr>
                    <tr>
                        <td>Schluckfunktion</td>
                        <td>Keine Aspiration</td>
                        <td>Bei Bedarf</td>
                        <td>Logop√§die, Konsistenzanpassung</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            <p><strong>Erstellt von:</strong> Arne Domachofski | <strong>Fachliche Qualifikation:</strong> Koch und Di√§ttisch geschulter Koch</p>
            <p><strong>Datum:</strong> 13. Juni 2025 | <strong>N√§chste √úberpr√ºfung:</strong> Individuell anpassbar</p>
            <p><em>Dieser Plan wurde nach aktuellen ern√§hrungsmedizinischen Leitlinien (DGEM, ESPEN) erstellt</em></p>
        </div>
    </div>

    <script>
        // Mapping of element IDs to keys in the JSON data
        const formElements = {
            'patientName': 'value',
            'patientAge': 'value',
            'patientGender': 'value',
            'currentWeight': 'value',
            'height': 'value',
            'targetWeight': 'value',
            'diagnosis': 'value',
            'swallowing': 'value',
            'activity': 'value',
            'specialNotes': 'value',
            'preferences': 'value',
            'dislikes': 'value',
            'weeklyGoal': 'value',
            'breakfastNormal': 'value',
            'breakfastModified': 'value',
            'snackNormal': 'value',
            'snackModified': 'value',
            'supplementType': 'selectedOptions' // Special handling for multi-select
        };

        function calculateValues() {
            const patientName = document.getElementById('patientName').value;
            const weight = parseFloat(document.getElementById('currentWeight').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseInt(document.getElementById('patientAge').value);
            const gender = document.getElementById('patientGender').value;
            const targetWeight = parseFloat(document.getElementById('targetWeight').value);
            const activityLevel = parseFloat(document.getElementById('activity').value);
            const weeklyGoal = parseFloat(document.getElementById('weeklyGoal').value);

            // Input validation
            if (isNaN(weight) || isNaN(height) || isNaN(age) || !gender || isNaN(targetWeight)) {
                alert('Bitte f√ºllen Sie alle erforderlichen Felder (Name, Gewicht, Gr√∂√üe, Alter, Geschlecht, Zielgewicht) aus, bevor Sie berechnen.');
                return;
            }

            // BMI berechnen
            const bmi = weight / ((height / 100) ** 2);
            const weightGain = targetWeight - weight;

            // BMI Ergebnis anzeigen
            const bmiResult = document.getElementById('bmiResult');
            const bmiValue = document.getElementById('bmiValue');
            const weightGainNeeded = document.getElementById('weightGainNeeded');

            bmiValue.textContent = `Aktueller BMI: ${bmi.toFixed(1)} kg/m¬≤`;
            weightGainNeeded.textContent = `Ben√∂tigte Gewichtszunahme: ${weightGain.toFixed(1)} kg`;
            bmiResult.style.display = 'block';

            // Grundumsatz berechnen (Mifflin-St Jeor)
            let bmr;
            if (gender === 'm√§nnlich') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else if (gender === 'weiblich') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            } else {
                // For 'divers' or if not specified, using a male formula as a general default
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5; 
            }

            // BMR Ergebnis anzeigen
            const bmrElem = document.getElementById('bmrResult');
            document.getElementById('bmrValue').textContent = `Grundumsatz (BMR): ${bmr.toFixed(0)} kcal/Tag`;
            bmrElem.style.display = 'block';

            // Gesamtenergiebedarf (Leistungsumsatz)
            const totalEnergy = bmr * activityLevel;

            // Gesamtenergiebedarf Ergebnis anzeigen
            const totalEnergyElem = document.getElementById('totalEnergyResult');
            document.getElementById('totalEnergyValue').textContent = `Gesamtenergiebedarf (ohne Zunahme): ${totalEnergy.toFixed(0)} kcal/Tag`;
            totalEnergyElem.style.display = 'block';

            // Zus√§tzlicher Energiebedarf f√ºr Gewichtszunahme
            let additionalCalories = 0;
            if (weeklyGoal === 0.25) {
                additionalCalories = 250;
            } else if (weeklyGoal === 0.75) {
                additionalCalories = 750;
            } else if (weeklyGoal === 1.0) {
                additionalCalories = 1000;
            }

            const finalTotalCalories = totalEnergy + additionalCalories;

            // Proteinbedarf (angenommen 1.2-1.5g/kg KG bei erh√∂htem Bedarf, hier pauschal 1.2g/kg)
            const proteinNeeds = weight * 1.2;

            // Endg√ºltige Ergebnisse anzeigen
            const finalResult = document.getElementById('finalResult');
            document.getElementById('maintenanceCalories').textContent = `Erhaltungsbedarf: ${totalEnergy.toFixed(0)} kcal/Tag`;
            document.getElementById('buildupCalories').textContent = `Zusatzbedarf f√ºr Gewichtszunahme: +${additionalCalories.toFixed(0)} kcal/Tag`;
            document.getElementById('totalCalories').textContent = `Gesamtenergiebedarf f√ºr Gewichtszunahme: ${finalTotalCalories.toFixed(0)} kcal/Tag`;
            document.getElementById('proteinNeeds').textContent = `Gesch√§tzter Proteinbedarf: ${proteinNeeds.toFixed(1)} g/Tag`;
            finalResult.style.display = 'block';
        }

        function saveData() {
            const data = {};
            for (const id in formElements) {
                const element = document.getElementById(id);
                if (element) {
                    if (formElements[id] === 'selectedOptions') {
                        data[id] = Array.from(element.selectedOptions).map(option => option.value);
                    } else {
                        data[id] = element.value;
                    }
                }
            }

            const patientName = document.getElementById('patientName').value || 'Unbekannt';
            const filename = `daten_${patientName.replace(/\s/g, '_')}.json`;
            
            const jsonString = JSON.stringify(data, null, 2); // Pretty print JSON

            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // Clean up memory
            alert(`Daten f√ºr ${patientName} wurden als "${filename}" zum Download bereitgestellt. Bitte speichere sie im selben Ordner wie diese HTML-Datei.`);
        }

        function loadData(fileContent) {
            try {
                const data = JSON.parse(fileContent);
                for (const id in formElements) {
                    const element = document.getElementById(id);
                    if (element && data[id] !== undefined) {
                        if (formElements[id] === 'selectedOptions') {
                            // Clear current selections first
                            Array.from(element.options).forEach(option => option.selected = false);
                            // Set new selections
                            data[id].forEach(selectedValue => {
                                const option = Array.from(element.options).find(opt => opt.value === selectedValue);
                                if (option) {
                                    option.selected = true;
                                }
                            });
                        } else {
                            element.value = data[id];
                        }
                    }
                }
                // Hide instruction after successful load
                document.getElementById('dataLoadInstruction').style.display = 'none';
                alert('Daten erfolgreich geladen!');
            } catch (e) {
                alert('Fehler beim Laden der Daten: Ung√ºltiges JSON-Format oder Datei. Details: ' + e.message);
                console.error('Error loading data:', e);
            }
        }

        function saveAsText() {
            const patientName = document.getElementById('patientName').value || 'Unbekannt';
            const patientAge = document.getElementById('patientAge').value || 'N/A';
            const patientGender = document.getElementById('patientGender').value || 'N/A';
            const currentWeight = document.getElementById('currentWeight').value || 'N/A';
            const height = document.getElementById('height').value || 'N/A';
            const targetWeight = document.getElementById('targetWeight').value || 'N/A';
            const diagnosis = document.getElementById('diagnosis').value || 'Keine Angabe';
            const swallowing = document.getElementById('swallowing').value || 'Keine Angabe';
            const activity = document.getElementById('activity').options[document.getElementById('activity').selectedIndex].text || 'N/A';
            const specialNotes = document.getElementById('specialNotes').value || 'Keine besonderen Hinweise';
            const preferences = document.getElementById('preferences').value || 'Keine Angabe';
            const dislikes = document.getElementById('dislikes').value || 'Keine Angabe';

            const bmiValue = document.getElementById('bmiValue').textContent || 'Noch nicht berechnet';
            const weightGainNeeded = document.getElementById('weightGainNeeded').textContent || 'Noch nicht berechnet';
            const bmrValue = document.getElementById('bmrValue').textContent || 'Noch nicht berechnet';
            const totalEnergyValue = document.getElementById('totalEnergyValue').textContent || 'Noch nicht berechnet';
            const maintenanceCalories = document.getElementById('maintenanceCalories').textContent || 'Noch nicht berechnet';
            const buildupCalories = document.getElementById('buildupCalories').textContent || 'Noch nicht berechnet';
            const totalCalories = document.getElementById('totalCalories').textContent || 'Noch nicht berechnet';
            const proteinNeeds = document.getElementById('proteinNeeds').textContent || 'Noch nicht berechnet';
            const weeklyGoal = document.getElementById('weeklyGoal').options[document.getElementById('weeklyGoal').selectedIndex].text || 'N/A';
            
            const breakfastNormal = document.getElementById('breakfastNormal').value || 'Nicht angegeben';
            const breakfastModified = document.getElementById('breakfastModified').value || 'Nicht angegeben';
            const snackNormal = document.getElementById('snackNormal').value || 'Nicht angegeben';
            const snackModified = document.getElementById('snackModified').value || 'Nicht angegeben';

            // Selected supplement types
            const supplementSelect = document.getElementById('supplementType');
            const selectedSupplements = Array.from(supplementSelect.selectedOptions).map(option => option.value).join(', ') || 'Keine spezifische Auswahl';


            // Get current date for the protocol
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
            const year = today.getFullYear();
            const formattedDate = `${day}.${month}.${year}`;

            const protocolTextContent = `
INDIVIDUELLER ERN√ÑHRUNGSPLAN - PFLEGEHEIM "HAUS SONNENSCHEIN"
Datum der Erstellung: ${formattedDate}

--------------------------------------------------------------------------------

üë§ BEWOHNERINFORMATIONEN

Name: ${patientName}
Alter: ${patientAge} Jahre
Geschlecht: ${patientGender}
Aktuelles Gewicht: ${currentWeight} kg
K√∂rpergr√∂√üe: ${height} cm
Zielgewicht: ${targetWeight} kg
${bmiValue}
${weightGainNeeded}

Hauptdiagnose: ${diagnosis}
Schluckbeschwerden: ${swallowing}
Aktivit√§tslevel: ${activity}
Besondere Hinweise: ${specialNotes}

--------------------------------------------------------------------------------

üçΩÔ∏è VORLIEBEN & ABNEIGUNGEN

Bevorzugte Speisen und Getr√§nke:
${preferences}

Abgelehnte Speisen, Allergien, Intoleranzen:
${dislikes}

--------------------------------------------------------------------------------

üìä ENERGIEBEDARFSBERECHNUNG

${bmrValue}
${totalEnergyValue}
Gew√ºnschte w√∂chentliche Zunahme: ${weeklyGoal}
${maintenanceCalories}
${buildupCalories}
${totalCalories}
${proteinNeeds}

--------------------------------------------------------------------------------

‚è∞ TAGESABLauf DER MAHLZEITENVERSORGUNG
Zuletzt aktualisiert am: ${formattedDate}

üåÖ Fr√ºhst√ºck (07:00 Uhr) - ca. 550 kcal:
  - Normale Konsistenz: ${breakfastNormal}
  - Bei Schluckbeschwerden: ${breakfastModified}

ü•® Zwischenmahlzeit (10:00 Uhr) - ca. 320 kcal:
  - Normale Konsistenz: ${snackNormal}
  - Bei Schluckbeschwerden: ${snackModified}

üçΩÔ∏è Mittagessen (12:30 Uhr) - ca. 540 kcal:
  - Siehe ausgeh√§ngter Speiseplan.
  - Anpassung der Konsistenz bei Schluckbeschwerden gem√§√ü Speiseplan und individuellen Bed√ºrfnissen (p√ºriert, passiert, angedickt).

‚òï Nachmittagssnack (15:30 Uhr) - ca. 380 kcal:
  - Normale Konsistenz: Milchkaffee (200ml), Grie√üpudding (150g), Fruchtsauce (50g)
  - Bei Schluckbeschwerden: Kaffee mit Andickmittel, Pudding glatt ger√ºhrt, Fruchtsauce passiert

üåô Abendessen (18:00 Uhr) - ca. 480 kcal:
  - Normale Konsistenz: Kr√§ftige Fleischbr√ºhe (200ml), Wei√übrot, entrindet (2 Scheiben), Streichk√§se (30g), Warme Milch (200ml)
  - Bei Schluckbeschwerden: Br√ºhe angedickt, Brot in Milch eingeweicht, K√§se geschmolzen/p√ºriert, Milch ggf. angedickt

üåÉ Sp√§tmahlzeit (20:30 Uhr) - ca. 290 kcal:
  - Normale Konsistenz: Trinknahrung (200ml) Oder: Milchshake mit Banane
  - Bei Schluckbeschwerden: Trinknahrung angedickt, l√∂ffelweise verabreichen

--------------------------------------------------------------------------------

üíä ZUS√ÑTZLICHE MASSNAHMEN & EMPFEHLUNGEN

Supplementierung:
- Hochkalorische Zusatzversorgung (Auswahl): ${selectedSupplements}
- Hochkalorische und vollbilanzierte Trinknahrung im Haus selbst hergestellt: 1-2x t√§glich zwischen den Mahlzeiten.

Konsistenzanpassungen bei Schluckbeschwerden:
- Fl√ºssigkeiten: IDDSI Level 1-3 je nach Bedarf
- Andickmittel: ModuleN oder ThickenUp bei Bedarf
- Texturen: P√ºrierte bis weiche Kost (IDDSI 4-6)
- Temperatur: Warme Speisen bevorzugt, keine extremen Temperaturen
`;
            // Add UTF-8 BOM to the beginning of the string
            const BOM = '\uFEFF';
            const finalProtocolText = BOM + protocolTextContent;

            const filename = `Ernaehrungsplan_${patientName.replace(/\s/g, '_')}_${formattedDate.replace(/\./g, '-')}.txt`;

            // Use data URI to force encoding
            const dataUri = 'data:text/plain;charset=utf-8,' + encodeURIComponent(finalProtocolText);

            const link = document.createElement('a');
            link.href = dataUri; // Use the data URI here
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearForm() {
            // Reset input fields
            for (const id in formElements) {
                const element = document.getElementById(id);
                if (element) {
                    if (formElements[id] === 'selectedOptions') {
                        Array.from(element.options).forEach(option => option.selected = false);
                    } else {
                        element.value = '';
                    }
                }
            }

            // Set default values for specific fields if necessary
            document.getElementById('activity').value = '1.2';
            document.getElementById('weeklyGoal').value = '0.25';


            // Hide result sections
            document.getElementById('bmiResult').style.display = 'none';
            document.getElementById('bmrResult').style.display = 'none';
            document.getElementById('totalEnergyResult').style.display = 'none';
            document.getElementById('finalResult').style.display = 'none';

            // Clear result texts (optional, as display:none hides them)
            document.getElementById('bmiValue').textContent = '';
            document.getElementById('weightGainNeeded').textContent = '';
            document.getElementById('bmrValue').textContent = '';
            document.getElementById('totalEnergyValue').textContent = '';
            document.getElementById('maintenanceCalories').textContent = '';
            document.getElementById('buildupCalories').textContent = '';
            document.getElementById('totalCalories').textContent = '';
            document.getElementById('proteinNeeds').textContent = '';
        }

        // --- New File Handling for Loading Data ---
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            const dataLoadInstruction = document.getElementById('dataLoadInstruction');

            // Show instruction if the page is loaded directly from file system
            if (window.location.protocol === 'file:') {
                dataLoadInstruction.style.display = 'block';
            }

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => loadData(e.target.result);
                    reader.readAsText(file);
                }
            });

            // Optional: Drag & Drop support
            dataLoadInstruction.addEventListener('dragover', (event) => {
                event.preventDefault();
                dataLoadInstruction.style.backgroundColor = '#f0f0f0'; // Visual feedback
            });

            dataLoadInstruction.addEventListener('dragleave', (event) => {
                event.preventDefault();
                dataLoadInstruction.style.backgroundColor = '';
            });

            dataLoadInstruction.addEventListener('drop', (event) => {
                event.preventDefault();
                dataLoadInstruction.style.backgroundColor = '';
                const file = event.dataTransfer.files[0];
                if (file && file.name.endsWith('.json')) {
                    const reader = new FileReader();
                    reader.onload = (e) => loadData(e.target.result);
                    reader.readAsText(file);
                } else {
                    alert('Bitte ziehe eine g√ºltige .json-Datei hierher.');
                }
            });
        });
    </script>
</body>
</html>
